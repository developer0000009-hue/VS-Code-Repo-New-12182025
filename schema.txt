
-- ===============================================================================================
--  GURUKUL OS - v23.1.6 EXPENSE SECURITY HANDSHAKE
--  RESOLVES: RLS Violation (42501) for Administrative Handshakes
-- ===============================================================================================

BEGIN;

-- 1. ENSURE TABLE ARCHITECTURE
CREATE TABLE IF NOT EXISTS public.school_expenses (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    branch_id BIGINT REFERENCES public.school_branches(id) NOT NULL, -- Strict constraint
    category TEXT NOT NULL,
    amount NUMERIC(15,2) NOT NULL CHECK (amount > 0),
    vendor_name TEXT,
    expense_date DATE DEFAULT CURRENT_DATE,
    description TEXT,
    payment_mode TEXT,
    invoice_url TEXT,
    status TEXT DEFAULT 'Pending',
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- 2. RESET GOVERNANCE POLICIES
ALTER TABLE public.school_expenses ENABLE ROW LEVEL SECURITY;
DROP POLICY IF EXISTS "Admin Manage Expenses" ON public.school_expenses;
DROP POLICY IF EXISTS "Accountant Manage Expenses" ON public.school_expenses;
DROP POLICY IF EXISTS "Unified Expense Management" ON public.school_expenses;

-- 3. IMPLEMENT GLOBAL ADMINISTRATIVE AUTHORITY
-- Grants full CRUD to Head Office and Super Admins
CREATE POLICY "Global Administrative Access" ON public.school_expenses
FOR ALL
TO authenticated
USING (
    EXISTS (
        SELECT 1 FROM public.profiles 
        WHERE id = auth.uid() 
        AND role IN ('Super Admin', 'School Administration')
    )
)
WITH CHECK (
    EXISTS (
        SELECT 1 FROM public.profiles 
        WHERE id = auth.uid() 
        AND role IN ('Super Admin', 'School Administration')
    )
);

-- 4. IMPLEMENT SCOPED BRANCH AUTHORITY
-- Grants local CRUD to Branch Admins and Accountants for their specific node
CREATE POLICY "Scoped Branch Access" ON public.school_expenses
FOR ALL
TO authenticated
USING (
    EXISTS (
        SELECT 1 FROM public.profiles 
        WHERE id = auth.uid() 
        AND branch_id = school_expenses.branch_id
        AND role IN ('Accountant', 'Branch Admin')
    )
)
WITH CHECK (
    EXISTS (
        SELECT 1 FROM public.profiles 
        WHERE id = auth.uid() 
        AND branch_id = branch_id
        AND role IN ('Accountant', 'Branch Admin')
    )
);

-- 5. REFRESH SCHEMA CACHE
NOTIFY pgrst, 'reload schema';

COMMIT;