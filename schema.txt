-- ===============================================================================================
--  GURUKUL OS - MASTER SCHEMA
--  Version: 12.5.0 (Identity Consistency & Multi-Verify)
-- ===============================================================================================

DO $$ 
BEGIN 
    -- 1. TEARDOWN REMAINING BIGINT CONSTRAINTS
    ALTER TABLE IF EXISTS public.admission_audit_logs DROP CONSTRAINT IF EXISTS admission_audit_logs_admission_id_fkey;
    ALTER TABLE IF EXISTS public.enquiry_messages DROP CONSTRAINT IF EXISTS enquiry_messages_admission_id_fkey;

    -- 2. CASCADE IDENTITY TYPE CHANGE (If not already UUID)
    IF EXISTS (SELECT 1 FROM information_schema.columns WHERE table_name='admission_audit_logs' AND column_name='admission_id' AND data_type='bigint') THEN
        ALTER TABLE public.admission_audit_logs ALTER COLUMN admission_id TYPE uuid USING (NULL);
    END IF;

    IF EXISTS (SELECT 1 FROM information_schema.columns WHERE table_name='enquiry_messages' AND column_name='admission_id' AND data_type='bigint') THEN
        ALTER TABLE public.enquiry_messages ALTER COLUMN admission_id TYPE uuid USING (NULL);
    END IF;

    -- 3. RE-ESTABLISH CRYPTOGRAPHIC LINKS
    IF EXISTS (SELECT 1 FROM information_schema.tables WHERE table_name = 'admission_audit_logs') THEN
        ALTER TABLE public.admission_audit_logs 
        ADD CONSTRAINT admission_audit_logs_admission_id_fkey 
        FOREIGN KEY (admission_id) REFERENCES public.admissions(id) ON DELETE CASCADE;
    END IF;

    IF EXISTS (SELECT 1 FROM information_schema.tables WHERE table_name = 'enquiry_messages') THEN
        ALTER TABLE public.enquiry_messages 
        ADD CONSTRAINT enquiry_messages_admission_id_fkey 
        FOREIGN KEY (admission_id) REFERENCES public.admissions(id) ON DELETE CASCADE;
    END IF;

END $$;

NOTIFY pgrst, 'reload schema';