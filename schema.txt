
-- ===============================================================================================
--  GURUKUL OS - v20.3.3 IDENTITY SYNC PATCH (Revision 10)
-- ===============================================================================================

BEGIN;

-- 1. Identity Discovery RPC
-- Efficiently probes all sub-registries to find established identities for a user node.
CREATE OR REPLACE FUNCTION public.get_user_completed_roles()
RETURNS TABLE (role_name TEXT, is_completed BOOLEAN) 
LANGUAGE plpgsql SECURITY DEFINER AS $$
BEGIN
    RETURN QUERY
    SELECT 'Parent/Guardian'::TEXT, EXISTS(SELECT 1 FROM public.parent_profiles WHERE user_id = auth.uid())
    UNION ALL
    SELECT 'School Administration'::TEXT, EXISTS(SELECT 1 FROM public.school_admin_profiles WHERE user_id = auth.uid())
    UNION ALL
    SELECT 'Teacher'::TEXT, EXISTS(SELECT 1 FROM public.teacher_profiles WHERE user_id = auth.uid())
    UNION ALL
    SELECT 'Student'::TEXT, EXISTS(SELECT 1 FROM public.student_profiles WHERE user_id = auth.uid());
END;
$$;

-- 2. Hardened Onboarding RPC
-- FIX: Explicitly drop existing function to allow return type change (Postgres 42P13)
DROP FUNCTION IF EXISTS public.complete_school_onboarding(TEXT, TEXT, TEXT, TEXT);

-- Finalizes the transition from onboarding to active institutional governance.
CREATE OR REPLACE FUNCTION public.complete_school_onboarding(
    p_admin_name TEXT,
    p_admin_email TEXT,
    p_admin_phone TEXT,
    p_designation TEXT
)
RETURNS JSONB LANGUAGE plpgsql SECURITY DEFINER AS $$
DECLARE
    v_user_id UUID := auth.uid();
BEGIN
    -- Update Core Identity
    UPDATE public.profiles 
    SET 
        display_name = p_admin_name,
        phone = p_admin_phone,
        profile_completed = true,
        updated_at = NOW()
    WHERE id = v_user_id;

    -- Seal Administrative Context
    UPDATE public.school_admin_profiles
    SET
        admin_contact_name = p_admin_name,
        admin_contact_email = p_admin_email,
        admin_contact_phone = p_admin_phone,
        admin_designation = p_designation,
        onboarding_step = 'completed',
        updated_at = NOW()
    WHERE user_id = v_user_id;

    RETURN jsonb_build_object('success', true, 'message', 'Institutional node activation successful.');
EXCEPTION WHEN OTHERS THEN
    RETURN jsonb_build_object('success', false, 'message', SQLERRM);
END;
$$;

-- 3. Admissions Registry Protocol (v2)
-- AMBIGUITY FIX: Explicitly drop overloaded signatures
DROP FUNCTION IF EXISTS public.get_admissions_v2(INTEGER);
DROP FUNCTION IF EXISTS public.get_admissions_v2(BIGINT);

-- Provides a scoped view of admission nodes for branch administrators.
CREATE OR REPLACE FUNCTION public.get_admissions_v2(p_branch_id BIGINT DEFAULT NULL)
RETURNS SETOF public.admissions LANGUAGE plpgsql SECURITY DEFINER AS $$
BEGIN
    RETURN QUERY
    SELECT * FROM public.admissions
    WHERE (p_branch_id IS NULL OR branch_id = p_branch_id)
    ORDER BY submitted_at DESC;
END;
$$;

-- 4. Enquiry Registry Protocol (v2)
-- AMBIGUITY FIX: Explicitly drop overloaded signatures
DROP FUNCTION IF EXISTS public.get_all_enquiries_v2(INTEGER);
DROP FUNCTION IF EXISTS public.get_all_enquiries_v2(BIGINT);

-- Provides a scoped view of enquiry nodes for branch administrators.
CREATE OR REPLACE FUNCTION public.get_all_enquiries_v2(p_branch_id BIGINT DEFAULT NULL)
RETURNS SETOF public.enquiries LANGUAGE plpgsql SECURITY DEFINER AS $$
BEGIN
    RETURN QUERY
    SELECT * FROM public.enquiries
    WHERE (p_branch_id IS NULL OR branch_id = p_branch_id)
    ORDER BY updated_at DESC;
END;
$$;

-- 5. Sync Table Columns
DO $$ 
BEGIN 
    -- Ensure phone column exists on profiles for base contact consistency
    IF NOT EXISTS (SELECT 1 FROM information_schema.columns WHERE table_name = 'profiles' AND column_name = 'phone') THEN
        ALTER TABLE public.profiles ADD COLUMN phone TEXT;
    END IF;
END $$;

COMMIT;
