
-- ===============================================================================================
--  GURUKUL OS - v21.0.4 SCHEMA PATCH (Enrollment Fixes)
-- ===============================================================================================

BEGIN;

-- 1. Schema Repairs
DO $$
BEGIN
    -- Fix: Add 'updated_at' to admissions if missing (Fixes: column "updated_at" does not exist)
    IF NOT EXISTS (SELECT 1 FROM information_schema.columns WHERE table_name = 'admissions' AND column_name = 'updated_at') THEN
        ALTER TABLE public.admissions ADD COLUMN updated_at TIMESTAMPTZ DEFAULT NOW();
    END IF;

    -- Fix: Ensure 'admission_audit_logs.admission_id' is UUID (Fixes: type mismatch bigint vs uuid)
    -- We truncate the logs table to ensure a clean type conversion if it contains legacy data
    IF EXISTS (
        SELECT 1 
        FROM information_schema.columns 
        WHERE table_name = 'admission_audit_logs' 
        AND column_name = 'admission_id' 
        AND data_type != 'uuid'
    ) THEN
        TRUNCATE TABLE public.admission_audit_logs;
        ALTER TABLE public.admission_audit_logs DROP COLUMN admission_id;
        ALTER TABLE public.admission_audit_logs ADD COLUMN admission_id UUID;
    END IF;
    
    -- Fix: Ensure 'document_requirements.admission_id' is UUID
    IF EXISTS (
        SELECT 1 
        FROM information_schema.columns 
        WHERE table_name = 'document_requirements' 
        AND column_name = 'admission_id' 
        AND data_type != 'uuid'
    ) THEN
        ALTER TABLE public.document_requirements ALTER COLUMN admission_id TYPE UUID USING admission_id::text::uuid;
    END IF;
END $$;

-- 2. Enhanced Enrollment Finalization Logic
CREATE OR REPLACE FUNCTION public.admin_finalize_enrollment(p_admission_id UUID)
RETURNS JSONB LANGUAGE plpgsql SECURITY DEFINER AS $$
DECLARE
    v_admission RECORD;
    v_new_student_id TEXT;
    v_new_roll_no TEXT;
    v_user_id UUID;
    v_year TEXT;
    v_generated_email TEXT;
BEGIN
    -- Fetch Admission Data
    SELECT * INTO v_admission FROM public.admissions WHERE id = p_admission_id;

    IF NOT FOUND THEN
        RETURN jsonb_build_object('success', false, 'message', 'Admission record not found.');
    END IF;

    IF v_admission.status = 'Enrolled' THEN
        RETURN jsonb_build_object('success', false, 'message', 'Student is already enrolled.');
    END IF;

    -- Generate Identifiers (e.g., STU-2025-1234)
    v_year := to_char(NOW(), 'YYYY');
    v_new_student_id := 'STU-' || v_year || '-' || floor(random() * (9999-1000 + 1) + 1000)::TEXT;
    v_new_roll_no := 'R-' || floor(random() * (99-10 + 1) + 10)::TEXT;
    v_generated_email := 'student.' || v_new_student_id || '@gurukul.system';

    -- Resolve User Identity
    -- If the admission wasn't linked to a user yet, we use the admission ID as a placeholder UUID for the new user profile
    v_user_id := COALESCE(v_admission.student_user_id, p_admission_id);

    -- Create/Update Core User Profile
    INSERT INTO public.profiles (id, display_name, email, role, is_active, profile_completed, created_at)
    VALUES (
        v_user_id,
        v_admission.applicant_name,
        v_generated_email, 
        'Student',
        true,
        true,
        NOW()
    )
    ON CONFLICT (id) DO UPDATE SET
        display_name = EXCLUDED.display_name,
        role = 'Student',
        is_active = true;

    -- Create Student Directory Entry
    INSERT INTO public.student_profiles (
        user_id,
        student_id_number,
        roll_number,
        grade,
        parent_guardian_details,
        branch_id,
        updated_at
    ) VALUES (
        v_user_id,
        v_new_student_id,
        v_new_roll_no,
        v_admission.grade,
        v_admission.parent_name || ' (' || v_admission.parent_phone || ')',
        v_admission.branch_id,
        NOW()
    )
    ON CONFLICT (user_id) DO UPDATE SET
        student_id_number = EXCLUDED.student_id_number,
        roll_number = EXCLUDED.roll_number,
        grade = EXCLUDED.grade,
        updated_at = NOW();

    -- Update Admission Status
    UPDATE public.admissions 
    SET 
        status = 'Enrolled',
        updated_at = NOW()
    WHERE id = p_admission_id;

    -- Log to Audit Trail
    INSERT INTO public.admission_audit_logs (
        admission_id,
        item_type,
        previous_status,
        new_status,
        changed_by,
        changed_by_name,
        details
    ) VALUES (
        p_admission_id,
        'ENROLLMENT_FINALIZED',
        v_admission.status,
        'Enrolled',
        auth.uid(),
        'System Administrator',
        jsonb_build_object('student_id', v_new_student_id, 'email', v_generated_email)
    );

    RETURN jsonb_build_object(
        'success', true, 
        'student_id', v_user_id,
        'student_id_number', v_new_student_id,
        'message', 'Student successfully enrolled.'
    );

EXCEPTION WHEN OTHERS THEN
    RETURN jsonb_build_object('success', false, 'message', SQLERRM);
END;
$$;

COMMIT;
