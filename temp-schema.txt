-- ===============================================================================================
-- GURUKUL OS - ACCESS PROTOCOL PATCH
-- Version: 12.3.2 (Identity Node Resilience)
-- ===============================================================================================

-- 5. DEFENSIVE DOCUMENT VERIFICATION RPC
CREATE OR REPLACE FUNCTION public.admin_verify_document(
    p_requirement_id BIGINT,
    p_status TEXT, 
    p_reason TEXT DEFAULT NULL
) RETURNS VOID LANGUAGE plpgsql SECURITY DEFINER SET search_path = public AS $$
DECLARE
    v_admission_id UUID;
    v_doc_name TEXT;
    v_current_status TEXT;
    v_parent_exists BOOLEAN;
    v_audit_table_exists BOOLEAN;
BEGIN
    -- Resolve context from requirement registry
    SELECT admission_id, document_name, status::text INTO v_admission_id, v_doc_name, v_current_status
    FROM public.document_requirements 
    WHERE id = p_requirement_id;

    IF v_admission_id IS NULL THEN
        RAISE EXCEPTION 'Identity Node Mismatch: Requirement % has no associated admission context.', p_requirement_id;
    END IF;

    -- Strict validation of parent identity node availability
    SELECT EXISTS (SELECT 1 FROM public.admissions WHERE id = v_admission_id) INTO v_parent_exists;

    IF NOT v_parent_exists THEN
        RAISE EXCEPTION 'Referenced identity node is unavailable. The parent record may have been moved or archived during synchronization.';
    END IF;

    -- Update requirement record state
    UPDATE public.document_requirements
    SET status = p_status::public.admission_status,
        rejection_reason = p_reason,
        updated_at = now()
    WHERE id = p_requirement_id;

    -- Check if audit table is provisioned
    SELECT EXISTS (
        SELECT 1 FROM information_schema.tables 
        WHERE table_schema = 'public' 
        AND table_name = 'admission_audit_logs'
    ) INTO v_audit_table_exists;

    -- Ledger Sync (Defensive)
    IF v_audit_table_exists THEN
        INSERT INTO public.admission_audit_logs (
            admission_id, 
            previous_status, 
            new_status, 
            changed_by, 
            changed_by_name
        )
        VALUES (
            v_admission_id, 
            'Artifact: ' || v_doc_name || ' (' || v_current_status || ')', 
            p_status || COALESCE(': ' || p_reason, ''),
            auth.uid(),
            COALESCE((SELECT display_name FROM profiles WHERE id = auth.uid()), 'System Admin')
        );
    END IF;
END;
$$;

NOTIFY pgrst, 'reload schema';